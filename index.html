<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>حاسبة رسوم الغرفة التجارية ببني سويف</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
<link rel="manifest" href="manifest (1).json">
<link rel="manifest" href="manifest (2).json">
<link rel="manifest" href="manifest (3).json">
<!-- html2pdf bundle (jsPDF + html2canvas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer=""></script>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root{
    --bg-dark:#020617;          /* slate-950 */
    --bg-1:#0b1220;
    --bg-2:#0f172a;             /* slate-900 */
    --glass: rgba(255,255,255,0.06);
    --glass-2: rgba(255,255,255,0.10);
    --border: rgba(255,255,255,0.16);
    --brand:#7c3aed;            /* violet-600 */
    --brand-2:#22d3ee;          /* cyan-400 */
    --brand-3:#38bdf8;          /* sky-400 */
    --accent:#16a34a;           /* green-600 */
    --text:#e5e7eb;
    --muted:#94a3b8;
    --danger:#ef4444;
    --warning:#f59e0b;
  }

  /* وضع النهاري */
  [data-theme="light"] {
    --bg-dark: #f1f5f9;
    --bg-1: #e2e8f0;
    --bg-2: #cbd5e1;
    --glass: rgba(15, 23, 42, 0.06);
    --glass-2: rgba(15, 23, 42, 0.10);
    --border: rgba(15, 23, 42, 0.16);
    --text: #0f172a;
    --muted: #475569;
    --danger: #dc2626;
    --warning: #d97706;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    color:var(--text);
    background:
      radial-gradient(1200px 600px at var(--mx,50%) var(--my,18%), rgba(34,211,238,0.18), transparent 60%),
      radial-gradient(900px 420px at calc(100% - var(--mx,50%)) calc(100% - var(--my,18%)), rgba(124,58,237,0.20), transparent 60%),
      conic-gradient(from 200deg at 60% 20%, #0a1020, #0b1b35, #0a1020);
    overflow-x:hidden;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
    transition: background 0.3s ease;
  }

  [data-theme="light"] body {
    background:
      radial-gradient(1200px 600px at var(--mx,50%) var(--my,18%), rgba(34,211,238,0.12), transparent 60%),
      radial-gradient(900px 420px at calc(100% - var(--mx,50%)) calc(100% - var(--my,18%)), rgba(124,58,237,0.15), transparent 60%),
      linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
  }

  /* BACKDROP CANVAS (particles) */
  #fx {
    position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.55;
    filter: blur(0.2px) saturate(1.1);
  }

  /* HEADER */
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter: blur(14px) saturate(1.1);
    background: linear-gradient(90deg, rgba(2,6,23,.55), rgba(15,23,42,.55));
    border-bottom:1px solid var(--border);
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  
  [data-theme="light"] header {
    background: linear-gradient(90deg, rgba(241, 245, 249, 0.85), rgba(226, 232, 240, 0.85));
    border-bottom: 1px solid rgba(148, 163, 184, 0.3);
  }
  
  .container{width:min(1200px,94vw); margin-inline:auto; padding:0 16px;}
  .brand{
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 0;
  }
  .logo{
    width:42px; aspect-ratio:1; border-radius:12px;
    background: conic-gradient(from 120deg, var(--brand), var(--brand-2), var(--brand-3), var(--brand));
    box-shadow: 0 8px 28px rgba(124,58,237,.45);
    position:relative; isolation:isolate;
    transition: all 0.3s ease;
  }
  
  [data-theme="light"] .logo {
    box-shadow: 0 8px 28px rgba(124,58,237,.3);
  }
  
  .logo:after{
    content:""; position:absolute; inset:2px; border-radius:10px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 35%), rgba(255,255,255,.06);
    mix-blend-mode:overlay;
  }
  h1{margin:0; font-size:clamp(18px,2.4vw,28px); letter-spacing:.2px}
  .subtitle{color:#cbd5e1; font-size:12px; margin-top:4px}
  
  [data-theme="light"] .subtitle {
    color: #475569;
  }

  /* GRID */
  .grid{display:grid; gap:12px}
  .cols-3{grid-template-columns: repeat(3, minmax(0,1fr))}
  .cols-2{grid-template-columns: repeat(2, minmax(0,1fr))}
  @media(max-width:1024px){ 
    .cols-3{grid-template-columns:1fr} 
    .cols-2{grid-template-columns:1fr} 
  }

  /* CARD (glass) */
  .card{
    position:relative;
    background:
      linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.035));
    border:1px solid var(--border);
    border-radius:20px; padding:16px;
    box-shadow: 0 10px 40px rgba(0,0,0,.30);
    transition: transform .2s ease, box-shadow .25s ease, border-color .2s ease;
    will-change: transform;
    overflow:hidden;
  }
  
  [data-theme="light"] .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 0 10px 40px rgba(0,0,0,.1);
  }
  
  .card:hover{ transform: translateY(-4px) perspective(1000px) rotateX(1.4deg) rotateY(-1.2deg);
    box-shadow: 0 18px 70px rgba(56,189,248,.22);
    border-color: rgba(255,255,255,.28);
  }
  
  [data-theme="light"] .card:hover {
    box-shadow: 0 18px 70px rgba(56,189,248,.15);
    border-color: rgba(124,58,237,.3);
  }
  
  .card .shine{
    position:absolute; inset:-40% -40% auto auto; height:120%; width:120%;
    background: radial-gradient(600px 200px at var(--mx,50%) var(--my,0%), rgba(34,211,238,.08), transparent 46%);
    pointer-events:none; z-index:0;
  }
  .card > *{position:relative; z-index:1}

  label{display:block; margin-bottom:6px; color:#cbd5e1; font-size:14px;}
  
  [data-theme="light"] label {
    color: #475569;
  }
  
  input, select, textarea{
    width:100%; padding:14px 16px; border-radius:14px; border:1px solid var(--border);
    background:rgba(2,6,23,0.55); color:#fff; outline:none; font-size:16px;
    transition:border-color .2s ease, box-shadow .2s ease, transform .05s ease;
  }
  
  [data-theme="light"] input, 
  [data-theme="light"] select, 
  [data-theme="light"] textarea {
    background: rgba(255, 255, 255, 0.9);
    color: #0f172a;
    border: 1px solid rgba(203, 213, 225, 0.8);
  }
  
  input:focus, select:focus, textarea:focus{ border-color:rgba(124,58,237,.7); box-shadow:0 0 0 5px rgba(124,58,237,.15) }
  input::placeholder { font-size: 14px; }

  /* BUTTONS */
  .btns{display:flex; gap:10px; flex-wrap:wrap}
  button{
    border:none; padding:14px 18px; border-radius:14px; cursor:pointer; font-weight:800; letter-spacing:.3px;
    background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:#081229; font-size:16px;
    box-shadow: 0 10px 28px rgba(124,58,237,.35);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
    min-height:48px;
    touch-action: manipulation;
  }
  button:hover{ transform: translateY(-2px); filter:saturate(1.2); box-shadow: 0 14px 40px rgba(34,211,238,.35) }
  button:active{ transform: translateY(0) scale(.98) }
  button.ghost{ background:transparent; color:#e2e8f0; border:1px solid var(--border); box-shadow:none }
  
  [data-theme="light"] button.ghost {
    color: #475569;
    border: 1px solid rgba(148, 163, 184, 0.5);
  }

  /* TOGGLE سجل (فردي/شركات) */
  .toggle-group{display:flex; gap:8px}
  .toggle-btn{
    flex:1; user-select:none; text-align:center; padding:14px; border-radius:14px;
    border:1px solid var(--border); background:rgba(2,6,23,.55); color:#e2e8f0; font-size:14px;
    box-shadow: inset 0 0 0 0 rgba(124,58,237,.0); transition:.2s;
    min-height:48px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  [data-theme="light"] .toggle-btn {
    background: rgba(255, 255, 255, 0.7);
    color: #475569;
  }
  
  .toggle-btn.active{
    background: radial-gradient(80% 120% at 30% 20%, rgba(56,189,248,.25), rgba(124,58,237,.35));
    border-color: rgba(255,255,255,.32);
    box-shadow: inset 0 0 0 2px rgba(124,58,237,.35), 0 8px 26px rgba(56,189,248,.25);
  }
  
  [data-theme="light"] .toggle-btn.active {
    background: radial-gradient(80% 120% at 30% 20%, rgba(56,189,248,.15), rgba(124,58,237,.25));
    border-color: rgba(124,58,237,.5);
    color: #0f172a;
  }

  /* TABLE */
  #tableWrap{max-height:420px; overflow:auto; border-radius:16px; -webkit-overflow-scrolling: touch;}
  table{ width:100%; border-collapse:collapse; direction:rtl; font-size:14px; }
  th, td{ padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:right }
  thead th{
    position:sticky; top:0; z-index:2; background:rgba(2,6,23,.65); backdrop-filter: blur(8px);
    font-weight:800; color:#cbd5e1; font-size:14px;
  }
  
  [data-theme="light"] thead th {
    background: rgba(241, 245, 249, 0.9);
    color: #475569;
  }
  
  [data-theme="light"] th, 
  [data-theme="light"] td {
    border-bottom: 1px solid rgba(203, 213, 225, 0.5);
  }
  
  /* صف الإجمالي الثابت */
  tfoot tr {
    position: sticky;
    bottom: 0;
    z-index: 3;
    background: rgba(2,6,23,.85);
    backdrop-filter: blur(8px);
    font-weight: 800;
  }
  
  [data-theme="light"] tfoot tr {
    background: rgba(241, 245, 249, 0.95);
  }
  
  tfoot td {
    border-top: 2px solid var(--brand);
    color: var(--brand-2);
  }
  
  [data-theme="light"] tfoot td {
    color: var(--brand);
  }

  /* STATS */
  .muted{color:var(--muted); font-size:14px;}
  .stat{ font-size: clamp(20px,2.3vw,28px); font-weight:800; letter-spacing:.2px }
  .total{ font-size: clamp(22px,2.6vw,30px); text-shadow: 0 6px 20px rgba(124,58,237,.28)}

  /* FOOTER */
  .footer{ color:#a3a3a3; font-size:.85rem; margin:28px 0 40px; text-align:center }
  
  [data-theme="light"] .footer {
    color: #64748b;
  }

  /* FLOAT TOAST */
  .toast{
    position:fixed; right:18px; bottom:18px; background:rgba(2,6,23,.92); color:#e2e8f0;
    border:1px solid var(--border); border-radius:14px; padding:12px 16px; z-index:40;
    box-shadow:0 14px 40px rgba(0,0,0,.35); transform: translateY(20px); opacity:0; transition:.25s;
    max-width: calc(100% - 36px);
    font-size: 14px;
  }
  
  [data-theme="light"] .toast {
    background: rgba(255, 255, 255, 0.95);
    color: #0f172a;
    border: 1px solid rgba(203, 213, 225, 0.8);
  }
  
  .toast.show{ transform:none; opacity:1 }

  /* MORPH BLOB - مخفف على الموبايل */
  .blob{
    position:fixed; inset:auto auto 10% 8%; width:320px; height:320px; border-radius:50%;
    background: radial-gradient(closest-side at 40% 40%, rgba(34,211,238,.25), transparent 60%),
                radial-gradient(closest-side at 70% 70%, rgba(124,58,237,.22), transparent 60%),
                linear-gradient(120deg, rgba(56,189,248,.22), rgba(124,58,237,.22));
    filter: blur(20px) saturate(1.2); mix-blend-mode:screen; pointer-events:none; z-index:0;
    animation: morph 16s ease-in-out infinite;
  }
  @media (max-width: 768px) {
    .blob {
      width: 220px;
      height: 220px;
      opacity: 0.7;
    }
  }
  @keyframes morph{
    0%{ border-radius: 36% 64% 58% 42% / 40% 36% 64% 60% }
    25%{ border-radius: 60% 40% 42% 58% / 36% 64% 60% 40% }
    50%{ border-radius: 44% 56% 62% 38% / 60% 42% 58% 40% }
    75%{ border-radius: 64% 36% 40% 60% / 44% 56% 36% 64% }
    100%{ border-radius: 36% 64% 58% 42% / 40% 36% 64% 60% }
  }

  /* WATERMARK for PDF preview (hidden in UI) */
  .wm{ position:fixed; inset:auto 16px 16px auto; opacity:.08; font-weight:800; font-size:42px; pointer-events:none; display:none }

  /* ACCENT DIVIDER */
  .divider{
    height:1px; border:none; margin:18px 0;
    background: linear-gradient(90deg, transparent, rgba(124,58,237,.45), rgba(34,211,238,.45), transparent);
  }
  
  [data-theme="light"] .divider {
    background: linear-gradient(90deg, transparent, rgba(124,58,237,.3), rgba(34,211,238,.3), transparent);
  }

  /* NEW STYLES FOR ADDED SECTIONS */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  .summary-card {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 14px;
    padding: 14px;
    border: 1px solid var(--border);
  }
  
  [data-theme="light"] .summary-card {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .summary-card h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: var(--muted);
  }
  .summary-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--brand-2);
  }
  
  [data-theme="light"] .summary-value {
    color: var(--brand);
  }
  
  @media (max-width: 768px) {
    .summary-grid {
      grid-template-columns: 1fr;
    }
    .summary-card {
      padding: 12px;
    }
    .summary-value {
      font-size: 16px;
    }
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .container {
      padding: 0 12px;
    }
    .card {
      padding: 14px;
      border-radius: 18px;
    }
    input, select, textarea {
      padding: 16px 14px;
      font-size: 16px; /* منع التكبير التلقائي على iOS */
    }
    button {
      padding: 16px;
      font-size: 15px;
    }
    .toggle-btn {
      padding: 12px;
      font-size: 13px;
    }
    .btns {
      flex-direction: column;
    }
    .btns button {
      width: 100%;
    }
    #tableWrap {
      max-height: 320px;
    }
    table {
      font-size: 13px;
    }
    th, td {
      padding: 10px 8px;
    }
  }

  /* Prevent zoom on input focus on iOS */
  @media screen and (max-width: 768px) {
    input, select, textarea {
      font-size: 16px;
    }
  }

  /* PDF-specific styles */
  .pdf-page {
    page-break-after: always;
    padding: 15mm;
    font-family: 'Tajawal', sans-serif;
    height: 277mm; /* A4 height minus margins */
    box-sizing: border-box;
  }
  .pdf-page:last-child {
    page-break-after: auto;
  }
  .pdf-header, .pdf-footer {
    text-align: center;
  }
  .pdf-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    page-break-inside: auto;
    font-size: 10px;
  }
  .pdf-table th, .pdf-table td {
    border: 1px solid #ddd;
    padding: 6px;
    text-align: right;
  }
  .pdf-table th {
    background-color: #f2f2f2;
  }
  .pdf-table tr {
    page-break-inside: avoid;
    page-break-after: auto;
  }

  /* NEW: Animations and effects */
  .glowing-border {
    position: relative;
  }
  .glowing-border::after {
    content: '';
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    background: linear-gradient(45deg, #ff00cc, #3333ff, #00ff99, #ffcc00);
    border-radius: 16px;
    z-index: -1;
    animation: border-pulse 3s ease infinite;
    opacity: 0.7;
    filter: blur(4px);
  }
  @keyframes border-pulse {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 0.3; }
  }

  .floating-element {
    animation: float 6s ease-in-out infinite;
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  .progress-bar {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
    margin: 10px 0;
  }
  
  [data-theme="light"] .progress-bar {
    background: rgba(203, 213, 225, 0.5);
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--brand), var(--brand-2));
    border-radius: 3px;
    transition: width 0.5s ease;
  }

  .info-badge {
    display: inline-block;
    background: rgba(56, 189, 248, 0.2);
    color: var(--brand-3);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    margin-left: 8px;
    border: 1px solid rgba(56, 189, 248, 0.3);
  }
  
  [data-theme="light"] .info-badge {
    background: rgba(56, 189, 248, 0.1);
    color: var(--brand);
  }
  
  /* NEW: زر حساب الرسوم في الأعلى */
  .sticky-calc-btn {
    position: sticky;
    top: 80px;
    z-index: 5;
    margin-top: 10px;
    margin-bottom: 20px;
  }
  
  /* NEW: تنسيق الإجمالي الكلي */
  .grand-total-highlight {
    background: linear-gradient(135deg, #7c3aed, #22d3ee);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 10px rgba(124, 58, 237, 0.3);
  }
  
  /* NEW: تنسيق الصفحات في PDF */
  .pdf-summary-page {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    color: #0f172a;
    padding: 20mm;
  }
  
  .pdf-details-page {
    background: #ffffff;
    color: #0f172a;
    padding: 20mm;
  }
  
  /* NEW: زر التبديل بين الوضعين - IMPROVED */
  .theme-toggle {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  .theme-toggle::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--brand), var(--brand-2));
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 50%;
  }
  
  .theme-toggle:hover::before {
    opacity: 0.1;
  }
  
  .theme-toggle svg {
    position: relative;
    z-index: 1;
    transition: transform 0.5s ease;
  }
  
  .theme-toggle:hover svg {
    transform: rotate(180deg);
  }
  
  [data-theme="light"] .theme-toggle {
    border: 1px solid rgba(203, 213, 225, 0.8);
    color: #475569;
  }
  
  [data-theme="light"] .theme-toggle:hover {
    background: rgba(15, 23, 42, 0.05);
  }
  
  /* NEW: تنسيق الخلايا المميزة */
  .highlight-positive {
    color: var(--accent);
    font-weight: 700;
  }
  
  [data-theme="light"] .highlight-positive {
    color: #16a34a;
  }
  
  .highlight-negative {
    color: var(--danger);
    font-weight: 700;
  }
  
  [data-theme="light"] .highlight-negative {
    color: #dc2626;
  }
  
  .highlight-total {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.15), rgba(34, 211, 238, 0.15)) !important;
    font-weight: 800;
  }
  
  [data-theme="light"] .highlight-total {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(34, 211, 238, 0.08)) !important;
  }
  
  /* NEW: History Section Styles */
  .history-section {
    margin-top: 24px;
  }
  
  .history-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .history-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    border-color: rgba(124,58,237,.5);
  }
  
  [data-theme="light"] .history-item {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  
  .history-title {
    font-weight: 700;
    font-size: 16px;
    color: var(--brand-2);
  }
  
  [data-theme="light"] .history-title {
    color: var(--brand);
  }
  
  .history-date {
    font-size: 12px;
    color: var(--muted);
  }
  
  .history-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    font-size: 13px;
  }
  
  .history-detail {
    display: flex;
    flex-direction: column;
  }
  
  .history-label {
    color: var(--muted);
    font-size: 11px;
  }
  
  .history-value {
    font-weight: 600;
  }
  
  .history-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    justify-content: flex-end;
  }
  
  .history-btn {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 8px;
    min-height: auto;
  }
  
  /* NEW: Accordion Styles */
  .accordion {
    margin-top: 16px;
  }
  
  .accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all 0.3s ease;
  }
  
  .accordion-header:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  [data-theme="light"] .accordion-header {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .accordion-title {
    font-weight: 700;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .accordion-icon {
    transition: transform 0.3s ease;
  }
  
  .accordion.open .accordion-icon {
    transform: rotate(180deg);
  }
  
  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }
  
  .accordion.open .accordion-content {
    max-height: 1000px;
  }
  
  /* NEW: Pulse animation for highlights */
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  .pulse {
    animation: pulse 2s infinite;
  }
  
  /* NEW: Improved PDF styles */
  .pdf-logo {
    width: 80px;
    height: 80px;
    margin: 0 auto 15px;
    background: linear-gradient(135deg, #7c3aed, #22d3ee);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
  }
  
  .pdf-watermark {
    position: absolute;
    opacity: 0.03;
    font-size: 120px;
    font-weight: 800;
    transform: rotate(-45deg);
    pointer-events: none;
    z-index: -1;
    top: 40%;
    left: 10%;
  }
  
  .pdf-header {
    position: relative;
    padding: 15px 0;
    margin-bottom: 20px;
    border-bottom: 2px solid #7c3aed;
  }
  
  .pdf-footer {
    margin-top: 30px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    font-size: 12px;
    color: #666;
  }
  
  .pdf-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    background: #7c3aed;
    color: white;
    font-size: 12px;
    margin-left: 8px;
  }
  
  /* NEW: Print-specific styles */
  @media print {
    body * {
      visibility: hidden;
    }
    .pdf-container, .pdf-container * {
      visibility: visible;
    }
    .pdf-container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
  }
  
  /* NEW: Enhanced glow effect */
  .enhanced-glow {
    position: relative;
  }
  
  .enhanced-glow::after {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    background: linear-gradient(45deg, #7c3aed, #22d3ee, #7c3aed);
    border-radius: 20px;
    z-index: -1;
    animation: enhanced-glow 3s ease infinite;
    opacity: 0.5;
    filter: blur(15px);
  }
  
  @keyframes enhanced-glow {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 0.8; }
  }
  
  /* NEW: Ripple effect for buttons */
  .ripple {
    position: relative;
    overflow: hidden;
  }
  
  .ripple::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }
  
  .ripple:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }
  
  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    20% {
      transform: scale(50, 50);
      opacity: 0.3;
    }
    100% {
      transform: scale(100, 100);
      opacity: 0;
    }
  }
  
  /* NEW: Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  
  .modal-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  .modal {
    background: var(--bg-2);
    border: 1px solid var(--border);
    border-radius: 20px;
    max-width: 90%;
    width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  
  [data-theme="light"] .modal {
    background: #ffffff;
    border: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .modal-overlay.active .modal {
    transform: scale(1);
  }
  
  .modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  [data-theme="light"] .modal-header {
    border-bottom: 1px solid rgba(226, 232, 240, 0.8);
  }
  
  .modal-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--brand-2);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  [data-theme="light"] .modal-title {
    color: var(--brand);
  }
  
  .modal-close {
    background: transparent;
    border: none;
    color: var(--muted);
    font-size: 24px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .modal-close:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }
  
  .modal-body {
    padding: 20px;
  }
  
  .modal-section {
    margin-bottom: 24px;
  }
  
  .modal-section:last-child {
    margin-bottom: 0;
  }
  
  .modal-section h3 {
    color: var(--brand-2);
    font-size: 18px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  [data-theme="light"] .modal-section h3 {
    color: var(--brand);
  }
  
  .modal-section p {
    line-height: 1.6;
    margin-bottom: 12px;
    color: var(--text);
  }
  
  [data-theme="light"] .modal-section p {
    color: #334155;
  }
  
  .fee-table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    overflow: hidden;
  }
  
  [data-theme="light"] .fee-table {
    background: rgba(241, 245, 249, 0.5);
  }
  
  .fee-table th, .fee-table td {
    padding: 12px;
    text-align: right;
    border-bottom: 1px solid var(--border);
  }
  
  [data-theme="light"] .fee-table th, 
  [data-theme="light"] .fee-table td {
    border-bottom: 1px solid rgba(226, 232, 240, 0.5);
  }
  
  .fee-table th {
    background: var(--brand);
    color: white;
    font-weight: 700;
  }
  
  .fee-table tr:last-child td {
    border-bottom: none;
  }
  
  .formula-box {
    background: rgba(124, 58, 237, 0.1);
    border: 1px solid rgba(124, 58, 237, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    font-family: 'Courier New', monospace;
    text-align: center;
    font-size: 16px;
    color: var(--brand-2);
  }
  
  [data-theme="light"] .formula-box {
    background: rgba(124, 58, 237, 0.05);
    border: 1px solid rgba(124, 58, 237, 0.2);
    color: var(--brand);
  }
  
  .note-box {
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
  }
  
  .note-box h4 {
    color: var(--warning);
    margin-top: 0;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .note-box p {
    margin: 0;
    color: var(--text);
  }
  
  [data-theme="light"] .note-box p {
    color: #334155;
  }

  /* NEW: Improved Theme Toggle */
  .enhanced-theme-toggle {
    position: relative;
    width: 120px;
    height: 50px;
    border-radius: 25px;
    background: linear-gradient(135deg, #1e293b, #334155);
    border: 1px solid rgba(255, 255, 255, 0.1);
    cursor: pointer;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    transition: all 0.5s ease;
  }
  
  [data-theme="light"] .enhanced-theme-toggle {
    background: linear-gradient(135deg, #e2e8f0, #f1f5f9);
    border: 1px solid rgba(203, 213, 225, 0.5);
  }
  
  .toggle-slider {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  
  [data-theme="light"] .toggle-slider {
    left: calc(100% - 45px);
    background: linear-gradient(135deg, #3b82f6, #60a5fa);
  }
  
  .toggle-icon {
    color: white;
    font-size: 18px;
    transition: all 0.5s ease;
  }
  
  .toggle-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }
  
  /* Stars for dark mode */
  .star {
    position: absolute;
    background-color: white;
    border-radius: 50%;
    animation: twinkle 4s infinite;
  }
  
  @keyframes twinkle {
    0%, 100% { opacity: 0.2; }
    50% { opacity: 1; }
  }
  
  /* Clouds for light mode */
  .cloud {
    position: absolute;
    background: white;
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  
  [data-theme="light"] .cloud {
    opacity: 0.7;
  }
  
  .cloud:before, .cloud:after {
    content: '';
    position: absolute;
    background: white;
    border-radius: 50%;
  }
  
  /* NEW: End Year Lock Button */
  .end-year-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .lock-btn {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    border: 1px solid var(--border);
    background: rgba(2,6,23,0.55);
    color: var(--text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  [data-theme="light"] .lock-btn {
    background: rgba(255, 255, 255, 0.7);
  }
  
  .lock-btn:hover {
    background: rgba(124, 58, 237, 0.2);
    border-color: rgba(124, 58, 237, 0.5);
  }
  
  .lock-btn.locked {
    background: rgba(34, 211, 238, 0.2);
    border-color: rgba(34, 211, 238, 0.5);
  }
  
  /* NEW: Table Column Controls */
  .column-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  
  .column-toggle {
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.05);
    color: var(--text);
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  [data-theme="light"] .column-toggle {
    background: rgba(255, 255, 255, 0.7);
  }
  
  .column-toggle.active {
    background: rgba(124, 58, 237, 0.2);
    border-color: rgba(124, 58, 237, 0.5);
  }
  
  .column-toggle .fa-eye,
  .column-toggle.active .fa-eye-slash {
    display: inline;
  }
  
  .column-toggle .fa-eye-slash,
  .column-toggle.active .fa-eye {
    display: none;
  }
  
  /* Hidden columns */
  .hide-capital .capital-col,
  .hide-room .room-col,
  .hide-sector .sector-col,
  .hide-penalty .penalty-col {
    display: none;
  }
</style>
</head>
<body>
  <canvas id="fx"></canvas>
  <div class="blob" aria-hidden="true"></div>
  <div class="wm" aria-hidden="true">BNSW CHAMBER</div>

  <header>
    <div class="container brand">
      <div style="display:flex; align-items:center; gap:12px">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>حاسبة رسوم الغرفة التجارية ببني سويف</h1>
          <div class="subtitle">فكرة: راشد مصطفى راشد</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px">
        <div class="enhanced-theme-toggle" id="enhancedThemeToggle" title="تبديل الوضع النهاري/الليلي">
          <div class="toggle-background" id="toggleBackground"></div>
          <div class="toggle-slider">
            <i class="fas fa-moon toggle-icon"></i>
          </div>
        </div>
        <button id="methodologyBtn" class="ghost" title="منهجية الرسوم"><i class="fas fa-calculator"></i> منهجية الرسوم</button>
        <button id="historyBtn" class="ghost" title="عرض السجل"><i class="fas fa-history"></i> السجل</button>
        <button id="exportBtn" class="ghost" title="تصدير PDF"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
      </div>
    </div>
  </header>

  <main class="container" style="position:relative; z-index:1; padding:18px 0 30px">

    <!-- INPUTS -->
    <section class="card" id="controlsCard">
      <div class="shine"></div>
      <h2 style="margin:0 0 8px; font-size:20px;">المدخلات <span class="info-badge">تلقائي</span></h2>
      <p class="muted" style="margin:0 0 12px; font-size:14px;">أدخل البيانات التالية ثم اضغط <b>احسب الرسوم</b>. يمكنك إضافة تعديلات لرأس المال عبر السنوات.</p>

      <div class="grid cols-3">
        <div>
          <label>رأس المال (ج)</label>
          <input id="initialCapital" inputmode="decimal" placeholder="مثال: 150000">
        </div>
        <div>
          <label>سنة البداية</label>
          <input id="startYear" inputmode="numeric" maxlength="4" placeholder="مثال: 2015">
        </div>
        <div>
          <label>سنة النهاية</label>
          <div class="end-year-control">
            <input id="endYear" inputmode="numeric" maxlength="4" value="2025">
            <button id="lockEndYear" class="lock-btn locked" title="تفعيل/إلغاء القفل التلقائي">
              <i class="fas fa-lock"></i>
            </button>
          </div>
          <div class="muted" style="font-size:12px; margin-top:4px;">يتم تحديثها تلقائيًا عند القفل</div>
        </div>
      </div>

      <div style="height:10px"></div>
      <label>نوع السجل</label>
      <div class="toggle-group" id="recordTypeBtns">
        <div class="toggle-btn active" data-value="فردي">فردي</div>
        <div class="toggle-btn" data-value="شركات">شركات</div>
      </div>
      <input type="hidden" id="recordType" value="فردي">
      
      <!-- زر حساب الرسوم في الأعلى -->
      <div class="sticky-calc-btn">
        <div class="btns">
          <button id="calcBtn" type="button" class="glowing-border ripple"><i class="fas fa-calculator"></i> احسب الرسوم</button>
          <button id="clearAllBtn" class="ghost" type="button"><i class="fas fa-trash"></i> مسح الكل</button>
        </div>
      </div>

      <hr class="divider">

      <div class="grid cols-3">
        <div>
          <label>سنة التعديل</label>
          <input id="chgYear" inputmode="numeric" maxlength="4" placeholder="مثال: 2019">
        </div>
        <div>
          <label>رأس المال الجديد (ج)</label>
          <input id="chgCapital" inputmode="decimal" placeholder="مثال: 300000">
        </div>
        <div>
          <label>ملاحظة (اختياري)</label>
          <input id="chgNote" placeholder="مثل: زيادة رأس المال">
        </div>
      </div>
      <div class="btns" style="margin-top:12px">
        <button id="addChangeBtn" type="button" class="ripple"><i class="fas fa-plus"></i> إضافة تعديل</button>
        <button id="clearChangesBtn" class="ghost" type="button"><i class="fas fa-times"></i> مسح التعديلات</button>
      </div>

      <div id="changesList" style="margin-top:12px"></div>
    </section>

    <!-- STATS -->
    <section class="grid cols-3">
      <div class="card floating-element">
        <div class="shine"></div>
        <div class="muted">إجمالي رسوم الغرفة</div>
        <div class="stat" id="roomFees">0 ج</div>
        <div class="progress-bar">
          <div class="progress-fill" id="roomProgress" style="width: 0%"></div>
        </div>
      </div>
      <div class="card floating-element" style="animation-delay: 0.5s;">
        <div class="shine"></div>
        <div class="muted">إجمالي رسوم الشعبة</div>
        <div class="stat" id="sectorFees">0 ج</div>
        <div class="progress-bar">
          <div class="progress-fill" id="sectorProgress" style="width: 0%"></div>
        </div>
      </div>
      <div class="card floating-element" style="animation-delay: 1s;">
        <div class="shine"></div>
        <div class="muted">إجمالي الغرامات</div>
        <div class="stat" id="penalties">0 ج</div>
        <div class="progress-bar">
          <div class="progress-fill" id="penaltyProgress" style="width: 0%"></div>
        </div>
      </div>
    </section>

    <section class="card" id="grandCard">
      <div class="shine"></div>
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap">
        <h2 style="margin:0; font-size:20px;">الإجمالي الكلّي</h2>
        <button id="saveResultBtn" class="ghost" style="padding:8px 12px;"><i class="fas fa-save"></i> حفظ النتيجة</button>
      </div>
      <div class="total stat grand-total-highlight" id="grandTotal">0 ج</div>
      <div class="progress-bar">
        <div class="progress-fill" id="grandProgress" style="width: 0%"></div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="card" id="tableCard">
      <div class="shine"></div>
      <h2 style="font-size:20px;">التفصيل السنوي</h2>
      
      <!-- NEW: Column Controls -->
      <div class="column-controls" id="columnControls">
        <div class="column-toggle active" data-column="capital">
          <i class="fas fa-eye"></i>
          <i class="fas fa-eye-slash"></i>
          رأس المال
        </div>
        <div class="column-toggle active" data-column="room">
          <i class="fas fa-eye"></i>
          <i class="fas fa-eye-slash"></i>
          رسوم الغرفة
        </div>
        <div class="column-toggle active" data-column="sector">
          <i class="fas fa-eye"></i>
          <i class="fas fa-eye-slash"></i>
          رسوم الشعبة
        </div>
        <div class="column-toggle active" data-column="penalty">
          <i class="fas fa-eye"></i>
          <i class="fas fa-eye-slash"></i>
          الغرامات
        </div>
      </div>
      
      <div id="tableWrap">
        <table id="yearTable">
          <thead>
            <tr>
              <th>السنة</th>
              <th class="capital-col">رأس المال</th>
              <th class="room-col">رسوم الغرفة</th>
              <th class="sector-col">رسوم الشعبة</th>
              <th class="penalty-col">الغرامة</th>
              <th>الإجمالي</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td>الإجمالي</td>
              <td class="capital-col">-</td>
              <td class="room-col" id="totalRoomFeesCell">0</td>
              <td class="sector-col" id="totalSectorFeesCell">0</td>
              <td class="penalty-col" id="totalPenaltiesCell">0</td>
              <td id="totalGrandCell">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
      
      <!-- NEW SECTION: الإجماليات تحت الجدول -->
      <div class="summary-grid">
        <div class="summary-card">
          <h3>إجمالي رسوم الغرفة</h3>
          <div class="summary-value" id="totalRoomFees">0 ج</div>
        </div>
        <div class="summary-card">
          <h3>إجمالي رسوم الشعبة</h3>
          <div class="summary-value" id="totalSectorFees">0 ج</div>
        </div>
        <div class="summary-card">
          <h3>إجمالي الغرامات</h3>
          <div class="summary-value" id="totalPenalties">0 ج</div>
        </div>
        <div class="summary-card">
          <h3>الإجمالي الكلّي</h3>
          <div class="summary-value grand-total-highlight" id="totalGrand">0 ج</div>
        </div>
      </div>
      
      <!-- NEW SECTION: الرسوم الحالية والمتأخرة -->
      <div class="summary-grid" style="margin-top: 16px;">
        <div class="summary-card">
          <h3>رسوم الغرفة الحالية (آخر سنة)</h3>
          <div class="summary-value" id="currentRoomFee">0 ج</div>
        </div>
        <div class="summary-card">
          <h3>إجمالي رسوم الغرفة المتأخرة</h3>
          <div class="summary-value" id="delayedRoomFees">0 ج</div>
        </div>
      </div>
    </section>

    <!-- NEW SECTION: History -->
    <section class="card history-section">
      <div class="shine"></div>
      <div class="accordion" id="historyAccordion">
        <div class="accordion-header">
          <div class="accordion-title">
            <i class="fas fa-history"></i>
            <span>سجل الحسابات السابقة</span>
          </div>
          <div class="accordion-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="accordion-content">
          <div id="historyList" style="margin-top:16px">
            <div class="muted" style="text-align:center; padding:20px">لا توجد حسابات سابقة</div>
          </div>
        </div>
      </div>
    </section>

    <p class="footer">© <span id="yearNow"></span> – إعداد وبرمجة: راشد مصطفى</p>
  </main>

  <div id="toaster" class="toast" role="status" aria-live="polite"></div>
  
  <!-- Modal: منهجية الرسوم -->
  <div id="methodologyModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <i class="fas fa-calculator"></i>
          منهجية حساب الرسوم
        </h2>
        <button class="modal-close" id="closeMethodology">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h3><i class="fas fa-info-circle"></i> مقدمة</h3>
          <p>تم تصميم هذه الحاسبة لحساب رسوم الغرفة التجارية ببني سويف بناءً على اللوائح والقوانين المعمول بها. يتم حساب الرسوم بشكل دقيق مع مراعاة جميع التعديلات والغرامات المستحقة.</p>
        </div>
        
        <div class="modal-section">
          <h3><i class="fas fa-coins"></i> رسوم الغرفة</h3>
          <p>تُحسب رسوم الغرفة بناءً على رأس المال المسجل للمنشأة وفقاً للشرائح التالية:</p>
          <div class="formula-box">
            رسوم الغرفة = رأس المال × نسبة الرسم
          </div>
          <table class="fee-table">
            <thead>
              <tr>
                <th>رأس المال</th>
                <th>نسبة الرسم</th>
                <th>الحد الأدنى</th>
                <th>الحد الأقصى</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>حتى 12,000 جنيه</td>
                <td>-</td>
                <td>24 جنيه</td>
                <td>24 جنيه</td>
              </tr>
              <tr>
                <td>حتى 1,000,000 جنيه</td>
                <td>0.2%</td>
                <td>24 جنيه</td>
                <td>2,000 جنيه</td>
              </tr>
              <tr>
                <td>أكثر من 1,000,000 جنيه</td>
                <td>-</td>
                <td>2,000 جنيه</td>
                <td>2,000 جنيه</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="modal-section">
          <h3><i class="fas fa-building"></i> رسوم الشعبة</h3>
          <p>تختلف رسوم الشعبة حسب نوع السجل (فردي أو شركات) والسنة المالية:</p>
          <table class="fee-table">
            <thead>
              <tr>
                <th>الفترة الزمنية</th>
                <th>سجل فردي</th>
                <th>سجل شركات</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>قبل عام 2002</td>
                <td>2 جنيه</td>
                <td>2 جنيه</td>
              </tr>
              <tr>
                <td>2002 - 2017</td>
                <td>5 جنيه</td>
                <td>10 جنيه</td>
              </tr>
              <tr>
                <td>2018 - 2019</td>
                <td>10 جنيه</td>
                <td>20 جنيه</td>
              </tr>
              <tr>
                <td>2020 - 2024</td>
                <td>25 جنيه</td>
                <td>50 جنيه</td>
              </tr>
              <tr>
                <td>2025 فما بعد</td>
                <td>100 جنيه</td>
                <td>200 جنيه</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="modal-section">
          <h3><i class="fas fa-exclamation-triangle"></i> الغرامات</h3>
          <p>تُحسب الغرامات على السنوات المتأخرة فقط (السنة الحالية - 1) بنسبة 25% من رسوم الغرفة:</p>
          <div class="formula-box">
            الغرامة = رسوم الغرفة × 0.25
          </div>
          <div class="note-box">
            <h4><i class="fas fa-lightbulb"></i> ملاحظة هامة</h4>
            <p>لا تُطبق الغرامات على السنة الحالية، فقط على السنوات السابقة التي لم يتم سداد رسومها. يتم حساب الغرامات بدقة عشرية بدون تقريب.</p>
          </div>
        </div>
        
        <div class="modal-section">
          <h3><i class="fas fa-calculator"></i> الإجمالي الكلي</h3>
          <p>يتم حساب الإجمالي الكلي لكل سنة بجمع جميع المكونات:</p>
          <div class="formula-box">
            الإجمالي = رسوم الغرفة + رسوم الشعبة + الغرامة
          </div>
          <p>يتم استخدام دقة عشرية في جميع الحسابات لضمان النتائج الصحيحة، خاصة عند وجود كسور عشرية في الغرامات.</p>
        </div>
      </div>
    </div>
  </div>

<script>
/* ------------------ Global helpers ------------------ */
const root = document.documentElement;
// تغيير تنسيق الأرقام لعرضها بالعربية مع دعم الكسور العشرية
const nf = new Intl.NumberFormat('ar-EG',{minimumFractionDigits:0, maximumFractionDigits:2});
const $ = (q)=>document.querySelector(q);
const $$ = (q)=>Array.from(document.querySelectorAll(q));

// دالة لتحويل الأرقام العربية إلى إنجليزية للمعالجة
function convertArabicToEnglishDigits(input) {
  if (typeof input !== 'string') return input;
  
  const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
  const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
  
  let result = input;
  arabicDigits.forEach((arabicDigit, index) => {
    const regex = new RegExp(arabicDigit, 'g');
    result = result.replace(regex, englishDigits[index]);
  });
  
  return result;
}

// دالة للجمع الدقيق للأرقام العشرية
function preciseAdd(a, b) {
  // تحويل إلى أرقام عشرية دقيقة
  const numA = parseFloat(a.toFixed(10));
  const numB = parseFloat(b.toFixed(10));
  return parseFloat((numA + numB).toFixed(10));
}

// Detect mobile device
function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
         (window.innerWidth <= 768);
}

function toast(msg, type='info'){
  const t = $('#toaster');
  t.textContent = msg;
  t.style.borderColor = (type==='error')? 'rgba(239,68,68,.6)' : (type==='warn'? 'rgba(245,158,11,.6)' : 'var(--border)');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2200);
}

/* ------------------ Futuristic FX ------------------ */
// Parallax background cursor - disable on mobile for performance
let mx = window.innerWidth * .5, my = window.innerHeight * .18;
const lerp=(a,b,t)=>a+(b-a)*t;
if(!isMobile()) {
  window.addEventListener('mousemove', (e)=>{ mx=e.clientX; my=e.clientY; });
}
function raf(){
  // smooth update CSS vars
  const cs = getComputedStyle(root);
  const curX = parseFloat(cs.getPropertyValue('--mx')||'50');
  const curY = parseFloat(cs.getPropertyValue('--my')||'18');
  const nx = lerp(curX, (mx/window.innerWidth)*100, .08);
  const ny = lerp(curY, (my/window.innerHeight)*100, .08);
  root.style.setProperty('--mx', nx.toFixed(2)+'%');
  root.style.setProperty('--my', ny.toFixed(2)+'%');
  requestAnimationFrame(raf);
}
root.style.setProperty('--mx','50%'); root.style.setProperty('--my','18%');
if(!isMobile()) {
  requestAnimationFrame(raf);
}

// Tilt on cards - disable on mobile
if(!isMobile()) {
  $$('.card').forEach(card=>{
    card.addEventListener('pointermove', e=>{
      const r = card.getBoundingClientRect();
      const x = (e.clientX - r.left)/r.width, y = (e.clientY - r.top)/r.height;
      const rx = (y-.5)*4, ry = (x-.5)*-4;
      card.style.transform = `perspective(1000px) rotateX(${rx}deg) rotateY(${ry}deg) translateY(-2px)`;
    });
    card.addEventListener('pointerleave', ()=>{ card.style.transform=''; });
  });
}

// Particles canvas - reduce on mobile
const cnv = document.getElementById('fx');
const ctx = cnv.getContext('2d');
let W,H,parts=[]; function rs(){ W=cnv.width=innerWidth; H=cnv.height=innerHeight; } rs(); addEventListener('resize', rs);
function spawn(){
  const n = isMobile() ? 40 : 120; // Reduce particles on mobile
  parts = Array.from({length:n}, ()=>({
    x: Math.random()*W, y: Math.random()*H,
    vx:(Math.random()-.5)*.25, vy:(Math.random()-.5)*.25,
    r: Math.random()*1.5+0.5, a: Math.random()*1, hue: 190+Math.random()*120
  }));
}
spawn();
(function loop(){
  ctx.clearRect(0,0,W,H);
  parts.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0||p.x>W) p.vx*=-1;
    if(p.y<0||p.y>H) p.vy*=-1;
    ctx.globalAlpha = 0.55*p.a;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = `hsla(${p.hue}, 80%, 60%, .8)`; ctx.fill();
  });
  // soft links - reduce on mobile
  const maxLinks = isMobile() ? 6 : 12;
  for(let i=0; i<parts.length; i++){
    for(let j=i+1; j<i+maxLinks && j<parts.length; j++){
      const dx=parts[i].x-parts[j].x, dy=parts[i].y-parts[j].y, d=Math.hypot(dx,dy);
      if(d<90){
        ctx.globalAlpha = 0.08;
        ctx.strokeStyle = 'rgba(56,189,248,.6)';
        ctx.beginPath(); ctx.moveTo(parts[i].x, parts[i].y); ctx.lineTo(parts[j].x, parts[j].y); ctx.stroke();
      }
    }
  }
  requestAnimationFrame(loop);
})();

/* ------------------ Business logic ------------------ */
// Changes list
let changes = [];
let currentResult = null;

// Auto-update end year to current year
function updateEndYear() {
  if ($('#lockEndYear').classList.contains('locked')) {
    const currentYear = new Date().getFullYear();
    $('#endYear').value = currentYear;
  }
}
updateEndYear();

// Toggle lock for end year
$('#lockEndYear').addEventListener('click', function() {
  this.classList.toggle('locked');
  if (this.classList.contains('locked')) {
    this.innerHTML = '<i class="fas fa-lock"></i>';
    $('#endYear').readOnly = true;
    updateEndYear();
    toast('تم تفعيل التحديث التلقائي لسنة النهاية');
  } else {
    this.innerHTML = '<i class="fas fa-lock-open"></i>';
    $('#endYear').readOnly = false;
    toast('تم إلغاء التحديث التلقائي لسنة النهاية');
  }
});

function renderChanges(){
  const wrap = $('#changesList');
  if(!changes.length){ wrap.innerHTML = '<div class="muted">لا توجد تعديلات مضافة.</div>'; return; }
  const items = changes.map((c, i)=>
    `<div class="card" style="padding:10px; margin:8px 0">
       <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
         <div style="flex:1;"><b>${c.year}</b> — رأس المال: <b>${nf.format(c.capital)}</b> ج ${c.note?`<span class="muted">— ${c.note}</span>`:''}</div>
         <div class="btns">
           <button class="ghost" data-edit="${i}" style="padding:8px 12px; font-size:14px;"><i class="fas fa-edit"></i> تعديل</button>
           <button class="ghost" style="border-color:rgba(239,68,68,.45); color:#fecaca; padding:8px 12px; font-size:14px;" data-del="${i}"><i class="fas fa-trash"></i> حذف</button>
         </div>
       </div>
     </div>`).join('');
  wrap.innerHTML = items;
  wrap.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{ changes.splice(+btn.dataset.del,1); renderChanges(); });
  });
  wrap.querySelectorAll('button[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const c = changes[+btn.dataset.edit];
      $('#chgYear').value = c.year;
      $('#chgCapital').value = c.capital;
      $('#chgNote').value = c.note || '';
      changes.splice(+btn.dataset.edit,1); renderChanges();
    });
  });
}
$('#addChangeBtn').addEventListener('click', ()=>{
  const y = +convertArabicToEnglishDigits($('#chgYear').value.trim());
  const c = +convertArabicToEnglishDigits($('#chgCapital').value.trim());
  const note = $('#chgNote').value.trim();
  if(!y || !c){ return toast('سنة أو قيمة غير صحيحة', 'error'); }
  changes.push({year:y, capital:c, note});
  changes.sort((a,b)=>a.year-b.year);
  $('#chgYear').value=''; $('#chgCapital').value=''; $('#chgNote').value='';
  renderChanges();
});
$('#clearChangesBtn').addEventListener('click', ()=>{ changes = []; renderChanges(); });
renderChanges();

// Toggle فردي/شركات
$('#recordTypeBtns').addEventListener('click', (e)=>{
  const btn = e.target.closest('.toggle-btn'); if(!btn) return;
  $$('#recordTypeBtns .toggle-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); $('#recordType').value = btn.dataset.value;
});

// Fee rules
function roomFeeForCapital(cap){
  if(cap <= 12000) return 24.0;
  if(cap <= 1000000) return cap * 0.002;
  return 2000.0;
}

function compute(){
  const initialCapital = +convertArabicToEnglishDigits($('#initialCapital').value.trim());
  const startYear = +convertArabicToEnglishDigits($('#startYear').value.trim());
  const endYear = +convertArabicToEnglishDigits($('#endYear').value.trim());
  const type = $('#recordType').value;
  
  if(!initialCapital || !startYear || !endYear || endYear < startYear){
    toast('تحقق من المدخلات أولاً', 'warn'); return null;
  }
  
  const currentYear = new Date().getFullYear();
  const capitalByYear = {};
  for(let y=startYear; y<=endYear; y++) capitalByYear[y] = initialCapital;
  changes.sort((a,b)=>a.year-b.year);
  for(const ch of changes){ if(ch.year < startYear) continue; for(let y=ch.year; y<=endYear; y++) capitalByYear[y] = ch.capital; }

  // السنة السابقة عليها غرامات (السنة الحالية - 1)
  const lastPenaltyYear = currentYear - 1;
  let totalRoom=0, totalSector=0, totalPen=0; 
  let currentRoomFee = 0;
  let delayedRoomFees = 0;
  
  const rows=[];
  for(let y=startYear; y<=endYear; y++){
    const cap = capitalByYear[y] ?? initialCapital;
    const room = roomFeeForCapital(cap);
    let sector = 0;
    
    // حساب رسوم الشعبة حسب السنة
    if(y < 2002) {
      sector = (type==='فردي') ? 2 : 2; // قبل 2002: 2 جنيه للفردي والشركات
    } else if(y>=2002 && y<=2017) {
      sector = (type==='فردي') ? 5 : 10;
    } else if(y>=2018 && y<=2019) {
      sector = (type==='فردي') ? 10 : 20;
    } else if(y>=2020 && y<=2024) {
      sector = (type==='فردي') ? 25 : 50;
    } else if(y>=2025) {
      sector = (type==='فردي') ? 100 : 200;
    }
    
    // السنة السابقة (2024) عليها غرامات الآن - بدون تقريب
    const penalty = (y <= lastPenaltyYear) ? (room/4) : 0;
    const sum = preciseAdd(preciseAdd(room, sector), penalty);
    
    totalRoom = preciseAdd(totalRoom, room); 
    totalSector = preciseAdd(totalSector, sector); 
    totalPen = preciseAdd(totalPen, penalty);
    
    // حساب الرسوم الحالية والمتأخرة
    if (y === endYear) {
      currentRoomFee = room;
    }
    
    if (y < currentYear) {
      delayedRoomFees = preciseAdd(delayedRoomFees, room);
    }
    
    rows.push({year:y, capital:cap, room, sector, penalty, sum});
  }
  
  currentResult = {
    rows, 
    totals:{
      room:totalRoom, 
      sector:totalSector, 
      pen:totalPen, 
      grand: preciseAdd(preciseAdd(totalRoom, totalSector), totalPen)
    }, 
    currentFees: {
      room: currentRoomFee
    },
    delayedFees: {
      room: delayedRoomFees
    },
    meta:{
      initialCapital, startYear, endYear, type, lastPenaltyYear, currentYear
    },
    changes: [...changes],
    timestamp: new Date().toISOString()
  };
  
  return currentResult;
}

/* -------------- Rendering -------------- */
function animateNumber(el, to, duration=900){
  const from = +(el.dataset.val || '0');
  const start = performance.now();
  function frame(t){
    const p = Math.min(1, (t-start)/duration);
    const ease = 1 - Math.pow(1-p, 3);
    const v = from + (to-from)*ease;
    el.textContent = nf.format(v) + ' ج';
    if(p<1) requestAnimationFrame(frame); else el.dataset.val = to;
  }
  requestAnimationFrame(frame);
}

function updateProgressBars(totals, grandTotal) {
  // تحديث أشرطة التقدم بشكل نسبي
  const roomPercent = Math.min(100, (totals.room / grandTotal) * 100);
  const sectorPercent = Math.min(100, (totals.sector / grandTotal) * 100);
  const penaltyPercent = Math.min(100, (totals.pen / grandTotal) * 100);
  
  $('#roomProgress').style.width = roomPercent + '%';
  $('#sectorProgress').style.width = sectorPercent + '%';
  $('#penaltyProgress').style.width = penaltyPercent + '%';
  $('#grandProgress').style.width = '100%';
}

function renderTable(rows){
  const tb = $('#yearTable tbody');
  const frag = document.createDocumentFragment(); tb.innerHTML='';
  
  let totalRoom = 0, totalSector = 0, totalPen = 0, totalGrand = 0;
  
  for(const r of rows){
    const tr = document.createElement('tr');
    // تحديد إذا كانت السنة عليها غرامة
    const penaltyClass = r.penalty > 0 ? 'class="highlight-negative"' : '';
    
    tr.innerHTML = `<td>${r.year}</td>
                    <td class="capital-col">${nf.format(r.capital)}</td>
                    <td class="room-col highlight-positive">${nf.format(r.room)}</td>
                    <td class="sector-col highlight-positive">${nf.format(r.sector)}</td>
                    <td class="penalty-col" ${penaltyClass}>${nf.format(r.penalty)}</td>
                    <td class="highlight-total">${nf.format(r.sum)}</td>`;
    frag.appendChild(tr);
    
    // استخدام الجمع الدقيق للإجماليات
    totalRoom = preciseAdd(totalRoom, r.room);
    totalSector = preciseAdd(totalSector, r.sector);
    totalPen = preciseAdd(totalPen, r.penalty);
    totalGrand = preciseAdd(totalGrand, r.sum);
  }
  tb.appendChild(frag);
  
  // تحديث صف الإجمالي
  $('#totalRoomFeesCell').textContent = nf.format(totalRoom);
  $('#totalSectorFeesCell').textContent = nf.format(totalSector);
  $('#totalPenaltiesCell').textContent = nf.format(totalPen);
  $('#totalGrandCell').textContent = nf.format(totalGrand);
}

function updateSummaryTotals(totals, currentFees, delayedFees) {
  $('#totalRoomFees').textContent = nf.format(totals.room) + ' ج';
  $('#totalSectorFees').textContent = nf.format(totals.sector) + ' ج';
  $('#totalPenalties').textContent = nf.format(totals.pen) + ' ج';
  $('#totalGrand').textContent = nf.format(totals.grand) + ' ج';
  
  // تحديث الرسوم الحالية والمتأخرة
  $('#currentRoomFee').textContent = nf.format(currentFees.room) + ' ج';
  $('#delayedRoomFees').textContent = nf.format(delayedFees.room) + ' ج';
}

function calcAndRender(){
  const res = compute(); if(!res) return;
  animateNumber($('#roomFees'), res.totals.room);
  animateNumber($('#sectorFees'), res.totals.sector);
  animateNumber($('#penalties'), res.totals.pen);
  animateNumber($('#grandTotal'), res.totals.grand, 1100);
  
  // تحديث أشرطة التقدم
  updateProgressBars(res.totals, res.totals.grand);
  
  // تحديث الإجماليات تحت الجدول
  updateSummaryTotals(res.totals, res.currentFees, res.delayedFees);
  
  renderTable(res.rows);
  
  // التمرير إلى قسم النتائج
  setTimeout(() => {
    document.getElementById('tableCard').scrollIntoView({ behavior: 'smooth' });
  }, 300);
  
  // حفظ يدوي (بدون استرجاع تلقائي عند الفتح)
  try{
    const pack = {inputs:{
      initialCapital:$('#initialCapital').value,
      startYear:$('#startYear').value,
      endYear:$('#endYear').value,
      recordType:$('#recordType').value
    }, changes};
    localStorage.setItem('fees:last', JSON.stringify(pack));
  }catch{}
}

/* -------------- History System -------------- */
let historyItems = [];

function loadHistory() {
  try {
    const saved = localStorage.getItem('fees:history');
    if (saved) {
      historyItems = JSON.parse(saved);
    }
  } catch (e) {
    console.error('Error loading history:', e);
    historyItems = [];
  }
}

function saveHistory() {
  try {
    localStorage.setItem('fees:history', JSON.stringify(historyItems));
  } catch (e) {
    console.error('Error saving history:', e);
  }
}

function saveCurrentResult() {
  if (!currentResult) {
    toast('لا توجد نتيجة حالية لحفظها', 'warn');
    return;
  }
  
  // إضافة إلى السجل
  historyItems.unshift({
    ...currentResult,
    id: Date.now(),
    title: `حساب ${new Date().toLocaleDateString('ar-EG')}`
  });
  
  // حفظ فقط آخر 20 عنصر
  if (historyItems.length > 20) {
    historyItems = historyItems.slice(0, 20);
  }
  
  saveHistory();
  renderHistory();
  toast('تم حفظ النتيجة في السجل');
}

function renderHistory() {
  const historyList = $('#historyList');
  
  if (historyItems.length === 0) {
    historyList.innerHTML = '<div class="muted" style="text-align:center; padding:20px">لا توجد حسابات سابقة</div>';
    return;
  }
  
  historyList.innerHTML = historyItems.map(item => `
    <div class="history-item" data-id="${item.id}">
      <div class="history-header">
        <div class="history-title">${item.title}</div>
        <div class="history-date">${new Date(item.timestamp).toLocaleDateString('ar-EG')}</div>
      </div>
      <div class="history-details">
        <div class="history-detail">
          <span class="history-label">رأس المال</span>
          <span class="history-value">${nf.format(item.meta.initialCapital)} ج</span>
        </div>
        <div class="history-detail">
          <span class="history-label">الفترة</span>
          <span class="history-value">${item.meta.startYear} - ${item.meta.endYear}</span>
        </div>
        <div class="history-detail">
          <span class="history-label">الإجمالي</span>
          <span class="history-value" style="color: var(--brand);">${nf.format(item.totals.grand)} ج</span>
        </div>
      </div>
      <div class="history-actions">
        <button class="ghost history-btn history-load-btn"><i class="fas fa-undo"></i> استرجاع</button>
        <button class="ghost history-btn history-export-btn"><i class="fas fa-file-export"></i> تصدير</button>
        <button class="ghost history-btn history-delete-btn" style="border-color:rgba(239,68,68,.45); color:#fecaca;"><i class="fas fa-trash"></i> حذف</button>
      </div>
    </div>
  `).join('');
  
  // إضافة معالجات الأحداث للأزرار
  historyList.querySelectorAll('.history-load-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const itemId = this.closest('.history-item').dataset.id;
      loadHistoryItem(itemId);
    });
  });
  
  historyList.querySelectorAll('.history-export-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const itemId = this.closest('.history-item').dataset.id;
      exportHistoryItem(itemId);
    });
  });
  
  historyList.querySelectorAll('.history-delete-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const itemId = this.closest('.history-item').dataset.id;
      deleteHistoryItem(itemId);
    });
  });
  
  // إضافة معالجة النقر على العنصر نفسه
  historyList.querySelectorAll('.history-item').forEach(item => {
    item.addEventListener('click', function(e) {
      if (!e.target.closest('.history-actions')) {
        loadHistoryItem(this.dataset.id);
      }
    });
  });
}

function loadHistoryItem(id) {
  const item = historyItems.find(i => i.id == id);
  if (!item) return;
  
  // تحميل البيانات إلى النموذج
  $('#initialCapital').value = item.meta.initialCapital;
  $('#startYear').value = item.meta.startYear;
  $('#endYear').value = item.meta.endYear;
  
  // تعيين نوع السجل
  $$('#recordTypeBtns .toggle-btn').forEach(b => b.classList.remove('active'));
  $(`#recordTypeBtns .toggle-btn[data-value="${item.meta.type}"]`).classList.add('active');
  $('#recordType').value = item.meta.type;
  
  // تحميل التعديلات
  changes = [...item.changes];
  renderChanges();
  
  // إعادة حساب النتائج
  calcAndRender();
  
  toast('تم تحميل الحساب من السجل');
}

function exportHistoryItem(id) {
  const item = historyItems.find(i => i.id == id);
  if (!item) return;
  
  // تخزين النتيجة الحالية مؤقتاً
  const tempResult = currentResult;
  currentResult = item;
  
  // إنشاء PDF
  exportPDF().finally(() => {
    currentResult = tempResult;
  });
}

function deleteHistoryItem(id) {
  if (!confirm('هل أنت متأكد من حذف هذا الحساب من السجل؟')) return;
  
  historyItems = historyItems.filter(i => i.id != id);
  saveHistory();
  renderHistory();
  toast('تم حذف الحساب من السجل');
}

/* -------------- PDF Export (Pro) -------------- */
async function exportPDF(){
  if(isMobile()) {
    if(!confirm("عملية إنشاء PDF قد تستغرق بعض الوقت على الجهاز المحمول. هل تريد المتابعة؟")) {
      return;
    }
  }
  
  const comp = currentResult || compute(); 
  if(!comp){ 
    toast('لا توجد نتائج متاحة للتصدير', 'error');
    return;
  }
  
  const {rows, totals, currentFees, delayedFees, meta} = comp;

  // إنشاء عنصر PDF الرئيسي
  const pdfContainer = document.createElement('div');
  pdfContainer.style.fontFamily = 'Tajawal, sans-serif';
  pdfContainer.style.direction = 'rtl';
  pdfContainer.style.width = '100%';
  pdfContainer.style.background = '#fff';
  pdfContainer.style.color = '#000';

  // صفحة الإجماليات
  const summaryPage = document.createElement('div');
  summaryPage.className = 'pdf-page pdf-summary-page';
  summaryPage.innerHTML = `
    <div class="pdf-watermark">بني سويف</div>
    <div class="pdf-header">
      <div class="pdf-logo">غ<br>ت<br>ب<br>س</div>
      <h1 style="color: #7c3aed; font-size: 28px; margin-bottom: 5px; text-align: center;">تقرير حاسبة رسوم الغرفة التجارية</h1>
      <h2 style="color: #0f172a; font-size: 20px; margin-bottom: 10px; text-align: center;">بني سويف</h2>
      <p style="color: #64748b; text-align: center; margin: 0;">تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('ar-EG')}</p>
    </div>
    
    <div style="background: #ffffff; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <h3 style="color: #0f172a; border-bottom: 2px solid #7c3aed; padding-bottom: 12px; margin-top: 0; font-size: 20px;">
        <i class="fas fa-info-circle" style="margin-left: 8px;"></i>المدخلات الأساسية
      </h3>
      <table style="width: 100%; font-size: 16px;">
        <tr>
          <td style="padding: 10px; width: 40%;"><strong>رأس المال الأولي:</strong></td>
          <td style="padding: 10px;">${nf.format(meta.initialCapital)} ج</td>
        </tr>
        <tr>
          <td style="padding: 10px;"><strong>الفترة:</strong></td>
          <td style="padding: 10px;">من ${meta.startYear} إلى ${meta.endYear}</td>
        </tr>
        <tr>
          <td style="padding: 10px;"><strong>نوع السجل:</strong></td>
          <td style="padding: 10px;">${meta.type}</td>
        </tr>
        <tr>
          <td style="padding: 10px;"><strong>عدد السنوات:</strong></td>
          <td style="padding: 10px;">${meta.endYear - meta.startYear + 1} سنة</td>
        </tr>
      </table>
    </div>

    ${changes.length > 0 ? `
    <div style="background: #ffffff; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <h3 style="color: #0f172a; border-bottom: 2px solid #7c3aed; padding-bottom: 12px; margin-top: 0; font-size: 20px;">
        <i class="fas fa-edit" style="margin-left: 8px;"></i>تعديلات رأس المال
      </h3>
      <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
        <thead>
          <tr>
            <th style="border: 1px solid #ddd; padding: 10px; background: #f8fafc; text-align: center;">سنة التعديل</th>
            <th style="border: 1px solid #ddd; padding: 10px; background: #f8fafc; text-align: center;">رأس المال الجديد</th>
            <th style="border: 1px solid #ddd; padding: 10px; background: #f8fafc; text-align: center;">ملاحظة</th>
          </tr>
        </thead>
        <tbody>
          ${changes.map(c => `
            <tr>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${c.year}</td>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${nf.format(c.capital)} ج</td>
              <td style="border: 1px solid #ddd; padding: 10px; text-align: center;">${c.note || '-'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    ` : ''}

    <div style="background: #ffffff; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <h3 style="color: #0f172a; border-bottom: 2px solid #7c3aed; padding-bottom: 12px; margin-top: 0; font-size: 20px;">
        <i class="fas fa-file-invoice-dollar" style="margin-left: 8px;"></i>الرسوم الحالية والمتأخرة
      </h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: #f8fafc; padding: 16px; border-radius: 10px; border-left: 4px solid #7c3aed;">
          <div style="color: #64748b; font-size: 16px; margin-bottom: 8px;">رسوم الغرفة الحالية (${meta.endYear})</div>
          <div style="font-weight: bold; font-size: 20px; color: #7c3aed;">${nf.format(currentFees.room)} ج</div>
        </div>
        <div style="background: #f8fafc; padding: 16px; border-radius: 10px; border-left: 4px solid #ef4444;">
          <div style="color: #64748b; font-size: 16px; margin-bottom: 8px;">إجمالي رسوم الغرفة المتأخرة</div>
          <div style="font-weight: bold; font-size: 20px; color: #ef4444;">${nf.format(delayedFees.room)} ج</div>
        </div>
      </div>
    </div>

    <div style="background: #ffffff; padding: 20px; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      <h3 style="color: #0f172a; border-bottom: 2px solid #7c3aed; padding-bottom: 12px; margin-top: 0; font-size: 20px;">
        <i class="fas fa-calculator" style="margin-left: 8px;"></i>الإجماليات
      </h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div style="background: #f8fafc; padding: 16px; border-radius: 10px;">
          <div style="color: #64748b; font-size: 16px; margin-bottom: 8px;">إجمالي رسوم الغرفة</div>
          <div style="font-weight: bold; font-size: 20px;">${nf.format(totals.room)} ج</div>
        </div>
        <div style="background: #f8fafc; padding: 16px; border-radius: 10px;">
          <div style="color: #64748b; font-size: 16px; margin-bottom: 8px;">إجمالي رسوم الشعبة</div>
          <div style="font-weight: bold; font-size: 20px;">${nf.format(totals.sector)} ج</div>
        </div>
        <div style="background: #f8fafc; padding: 16px; border-radius: 10px;">
          <div style="color: #64748b; font-size: 16px; margin-bottom: 8px;">إجمالي الغرامات</div>
          <div style="font-weight: bold; font-size: 20px; color: #ef4444;">${nf.format(totals.pen)} ج</div>
        </div>
        <div style="background: linear-gradient(135deg, #7c3aed, #22d3ee); padding: 20px; border-radius: 12px; color: white;">
          <div style="font-size: 18px; margin-bottom: 8px;">الإجمالي الكلّي</div>
          <div style="font-weight: bold; font-size: 24px;">${nf.format(totals.grand)} ج</div>
        </div>
      </div>
    </div>
    
    <div class="pdf-footer">
      <p>تم إنشاء هذا التقرير بواسطة حاسبة رسوم الغرفة التجارية ببني سويف</p>
      <p>إعداد وبرمجة: راشد مصطفى © ${new Date().getFullYear()}</p>
    </div>
  `;
  pdfContainer.appendChild(summaryPage);

  // صفحة التفصيل السنوي
  const detailsPage = document.createElement('div');
  detailsPage.className = 'pdf-page pdf-details-page';
  detailsPage.innerHTML = `
    <div class="pdf-watermark">بني سويف</div>
    <div style="text-align: center; margin-bottom: 25px;">
      <h2 style="color: #7c3aed; font-size: 24px; margin-bottom: 10px;">
        <i class="fas fa-list-alt" style="margin-left: 8px;"></i>التفصيل السنوي للرسوم
      </h2>
      <p style="color: #64748b; margin: 0;">فترة ${meta.startYear} - ${meta.endYear}</p>
    </div>
    
    <table class="pdf-table" style="font-size: 12px;">
      <thead>
        <tr>
          <th style="padding: 10px; background: #7c3aed; color: white;">السنة</th>
          <th style="padding: 10px; background: #7c3aed; color: white;">رأس المال</th>
          <th style="padding: 10px; background: #7c3aed; color: white;">رسوم الغرفة</th>
          <th style="padding: 10px; background: #7c3aed; color: white;">رسوم الشعبة</th>
          <th style="padding: 10px; background: #7c3aed; color: white;">الغرامة</th>
          <th style="padding: 10px; background: #7c3aed; color: white;">الإجمالي</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${r.year}</td>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${nf.format(r.capital)}</td>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${nf.format(r.room)}</td>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">${nf.format(r.sector)}</td>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${r.penalty > 0 ? 'color: #ef4444; font-weight: bold;' : ''}">${nf.format(r.penalty)}</td>
            <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${nf.format(r.sum)}</td>
          </tr>
        `).join('')}
      </tbody>
      <tfoot>
        <tr>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center;">الإجمالي</td>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center;">-</td>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center;">${nf.format(totals.room)}</td>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center;">${nf.format(totals.sector)}</td>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center; color: #ef4444;">${nf.format(totals.pen)}</td>
          <td style="padding: 10px; font-weight: bold; border-top: 2px solid #7c3aed; text-align: center;">${nf.format(totals.grand)}</td>
        </tr>
      </tfoot>
    </table>
    
    <div class="pdf-footer">
      <p>صفحة 2 من 2</p>
      <p>تم إنشاء هذا التقرير بواسطة حاسبة رسوم الغرفة التجارية ببني سويف</p>
      <p>إعداد وبرمجة: راشد مصطفى © ${new Date().getFullYear()}</p>
    </div>
  `;
  pdfContainer.appendChild(detailsPage);

  // إعدادات PDF
  const opt = {
    margin: [10, 10, 10, 10],
    filename: `تقرير-رسوم-الغرفة-بني-سويف-${Date.now()}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { 
      scale: 2, 
      useCORS: true, 
      background: '#ffffff',
      logging: false,
      allowTaint: true,
      proxy: document.location.href
    },
    jsPDF: { 
      unit: 'mm', 
      format: 'a4', 
      orientation: 'portrait',
      compress: true
    }
  };

  // إنشاء PDF
  try {
    toast('جاري إنشاء ملف PDF...');
    await html2pdf().set(opt).from(pdfContainer).save();
    toast('تم تصدير PDF بنجاح');
  } catch (error) {
    console.error('Error generating PDF:', error);
    toast('حدث خطأ أثناء إنشاء PDF', 'error');
  }
}

/* -------------- Wire UI -------------- */
$('#calcBtn').addEventListener('click', calcAndRender);
$('#clearAllBtn').addEventListener('click', ()=>{
  // مسح كل الحقول ما عدا سنة النهاية
  $('#initialCapital').value = '';
  $('#startYear').value = '';
  // لا نمسح سنة النهاية
  changes=[]; renderChanges();
  $('#yearTable tbody').innerHTML='';
  ['#roomFees','#sectorFees','#penalties','#grandTotal'].forEach(sel=>{ const el=$(sel); el.dataset.val='0'; el.textContent='0 ج'; });
  // مسح القيم الجديدة
  ['#totalRoomFees','#totalSectorFees','#totalPenalties','#totalGrand','#currentRoomFee','#delayedRoomFees'].forEach(sel=>{ $(sel).textContent='0 ج'; });
  // إعادة تعيين أشرطة التقدم
  ['#roomProgress','#sectorProgress','#penaltyProgress','#grandProgress'].forEach(sel=>{ $(sel).style.width = '0%'; });
  toast('تم مسح كل البيانات');
});
$('#exportBtn').addEventListener('click', exportPDF);
$('#saveResultBtn').addEventListener('click', saveCurrentResult);

// Methodology Modal
$('#methodologyBtn').addEventListener('click', () => {
  $('#methodologyModal').classList.add('active');
  document.body.style.overflow = 'hidden';
});

$('#closeMethodology').addEventListener('click', () => {
  $('#methodologyModal').classList.remove('active');
  document.body.style.overflow = '';
});

// Close modal when clicking outside
$('#methodologyModal').addEventListener('click', (e) => {
  if (e.target === $('#methodologyModal')) {
    $('#methodologyModal').classList.remove('active');
    document.body.style.overflow = '';
  }
});

// Accordion functionality
$('#historyAccordion .accordion-header').addEventListener('click', () => {
  $('#historyAccordion').classList.toggle('open');
});

// History button
$('#historyBtn').addEventListener('click', () => {
  $('#historyAccordion').classList.add('open');
  setTimeout(() => {
    document.getElementById('historyAccordion').scrollIntoView({ behavior: 'smooth' });
  }, 300);
});

// Keyboard shortcuts - disable on mobile
if(!isMobile()) {
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); $('#exportBtn').click(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#calcBtn').click(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='h'){ e.preventDefault(); $('#historyBtn').click(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); $('#saveResultBtn').click(); }
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='m'){ e.preventDefault(); $('#methodologyBtn').click(); }
    if(e.key === 'Escape' && $('#methodologyModal').classList.contains('active')){ 
      e.preventDefault(); 
      $('#methodologyModal').classList.remove('active');
      document.body.style.overflow = '';
    }
  });
}

/* -------------- Enhanced Theme Toggle -------------- */
function createStarsAndClouds() {
  const toggleBackground = $('#toggleBackground');
  toggleBackground.innerHTML = '';
  
  // Create stars for dark mode
  for (let i = 0; i < 15; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.width = Math.random() * 3 + 1 + 'px';
    star.style.height = star.style.width;
    star.style.top = Math.random() * 100 + '%';
    star.style.left = Math.random() * 100 + '%';
    star.style.animationDelay = Math.random() * 4 + 's';
    toggleBackground.appendChild(star);
  }
  
  // Create clouds for light mode
  for (let i = 0; i < 3; i++) {
    const cloud = document.createElement('div');
    cloud.className = 'cloud';
    cloud.style.width = '30px';
    cloud.style.height = '12px';
    cloud.style.top = (20 + i * 25) + '%';
    cloud.style.left = (10 + i * 30) + '%';
    
    cloud.style.borderRadius = '50%';
    cloud.style.background = 'white';
    
    cloud.style.boxShadow = `
      15px 5px 0 0 white,
      30px 0px 0 0 white,
      45px 5px 0 0 white
    `;
    
    toggleBackground.appendChild(cloud);
  }
}

$('#enhancedThemeToggle').addEventListener('click', () => {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // Update toggle icon
  const icon = $('#enhancedThemeToggle .toggle-icon');
  if (newTheme === 'light') {
    icon.className = 'fas fa-sun toggle-icon';
  } else {
    icon.className = 'fas fa-moon toggle-icon';
  }
  
  toast(`تم التبديل إلى الوضع ${newTheme === 'light' ? 'النهاري' : 'الليلي'}`);
});

// Load saved theme
const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.documentElement.setAttribute('data-theme', savedTheme);
  // Update toggle icon
  const icon = $('#enhancedThemeToggle .toggle-icon');
  if (savedTheme === 'light') {
    icon.className = 'fas fa-sun toggle-icon';
  } else {
    icon.className = 'fas fa-moon toggle-icon';
  }
}

// Create stars and clouds on load
createStarsAndClouds();

/* -------------- Table Column Controls -------------- */
function setupColumnControls() {
  const columnToggles = $$('.column-toggle');
  
  // Load saved column preferences
  const savedColumns = localStorage.getItem('tableColumns');
  if (savedColumns) {
    const columns = JSON.parse(savedColumns);
    columnToggles.forEach(toggle => {
      const column = toggle.dataset.column;
      if (columns[column] === false) {
        toggle.classList.remove('active');
        document.body.classList.add(`hide-${column}`);
      }
    });
  }
  
  columnToggles.forEach(toggle => {
    toggle.addEventListener('click', function() {
      this.classList.toggle('active');
      const column = this.dataset.column;
      
      if (this.classList.contains('active')) {
        document.body.classList.remove(`hide-${column}`);
      } else {
        document.body.classList.add(`hide-${column}`);
      }
      
      // Save column preferences
      const columns = {};
      columnToggles.forEach(t => {
        columns[t.dataset.column] = t.classList.contains('active');
      });
      localStorage.setItem('tableColumns', JSON.stringify(columns));
    });
  });
}

/* -------------- Ripple effect for buttons -------------- */
function setupRippleEffects() {
  $$('.ripple').forEach(btn => {
    btn.addEventListener('click', function(e) {
      const circle = document.createElement('span');
      const diameter = Math.max(this.clientWidth, this.clientHeight);
      const radius = diameter / 2;
      
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${e.clientX - this.getBoundingClientRect().left - radius}px`;
      circle.style.top = `${e.clientY - this.getBoundingClientRect().top - radius}px`;
      circle.classList.add('ripple-effect');
      
      const ripple = this.getElementsByClassName('ripple-effect')[0];
      if (ripple) ripple.remove();
      
      this.appendChild(circle);
    });
  });
}

/* -------------- Init -------------- */
document.getElementById('yearNow').textContent = new Date().getFullYear();
loadHistory();
renderHistory();
setupRippleEffects();
setupColumnControls();

// Accordion open by default if there are history items
if (historyItems.length > 0) {
  $('#historyAccordion').classList.add('open');
}

// Auto-update end year every minute if locked
setInterval(updateEndYear, 60000);
</script>

</body></html>